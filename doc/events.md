# Events

Событие - это "существенное изменение состояния" (web-приложения). Существенное - значит, что событие связанно с
некоторыми данными (количественными или качественными). У каждого события есть свой источник (agent) и один или более
потребителей (sinks). События от источника к потребителям двигаются по каналам.

An event-driven system typically consists of event emitters (or agents), event consumers (or sinks), and event channels.

## Event message

Сообщение о событии - это дата-объект (без поведения), состоящий из двух групп атрибутов:

* `data`: информационные атрибуты события (например: "запрос на аутентификацию пользователя с именем 'alex' и паролем '
  SomePassword').
* `meta`: служебные атрибуты события (имя события, генератор события, время генерации, время жизни, получатели и т.п.).

Первая группа атрибутов изменяется в зависимости от типа событий (аутентификация, перевод средств, оформление
заказа, ...), вторая группа зависит от среды, в которой циркулируют события (канала).

## Channels

### 'null' channel

Простейший случай - когда источник события напрямую информирует о событии его потребителя. В таком случае `meta`
-атрибуты вырождаются в ничего, а сам канал отсутствует. Если источник может генерировать события нескольких типов, то
в `meta`-атрибутах должен присутствовать тип события, чтобы получатель сообщения смог различать сообщения.

### Local channel

Если сообщение о событии передаётся от источников к потребителям в рамках одной среды выполнения (runtime
engine), то канал маршрутизирует сообщения на основании, как минимум, типа события.

### Instantiated events channel

Если есть множество источников и/или множество потребителей, то `meta`-атрибуты могут содержать идентификаторы источника
и/или получателя сообщения. Например, сообщение "изменилось значение" от ячейки `A1` ячейке `B2` в электронной таблице.
В подобном канале должна присутствовать маршрутизация сообщений - на основании `meta`-атрибутов сообщения доставляются
соответствующим потребителям.

### Throttled channel

Если события от источника к потребителю передаются по нестабильному каналу (который может спорадически закрываться для
передачи), то `meta`-атрибуты могут дополнительно содержать TTL-данные для конкретного сообщения.

## Event message factory

Структура сообщения о событии одинакова для всех событий:

* `data`
* `meta`

Но структура атрибута `data` отличается от события к событию, а структура атрибута `meta` - от канала к каналу.

В teq-приложении можно выделить следующие каналы:

* `локальный`: сообщения о событии не выходят за рамки текущей области исполнения кода (фронт или бэк).
* `трансграничный`: сообщение о событии передаётся с фронта на бэк или наоборот.

Трансграничные сообщения можно разделить по типу взаимодействия:

* `one-way`: сообщения, не требующие обратного ответа;
* `call`: сообщения, ожидающие ответ от "другой" стороны;

`back-to-front` сообщения также можно разделить по типу адресата:

* `to-front`: сообщения конкретному фронту (профилю в браузере);
* `to-session`: сообщения конкретной сессии (вкладке в браузере);

Call-сообщения (ожидающие ответ от другой стороны) не могут отправляться на несколько фронтов - проблемы с обратной
связью при приёме. Такие сообщения должны привязываться к сессии (вкладке в браузере).

## Event Metadata

### Common Meta

Metadata for local messages - `TeqFw_Web_Event_Shared_Dto_Event_Meta`:

```json
{
  "meta": {
    "name": "Dev_Shared_Event_Msg_Back_OneWay_Front",
    "published": "2022-12-23T05:13:47.927Z",
    "uuid": "405d7975-6cb4-40de-8899-ae4b2f9bb874"
  }
}
```

### Transborder Meta

Metadata for transborder messages - `TeqFw_Web_Event_Shared_Dto_Event_Meta_Trans` (extends `Meta`).

If `meta.encrypted` is `false` then message has a stamp (some text info about message) that is signed by agent's secret
key and is encrypted by sink's public key:

```json
{
  "meta": {
    "backUuid": "147069e9-fba5-4e69-88dd-1da1a785af8f",
    "encrypted": false,
    "expired": "2022-12-23T16:45:33.905Z",
    "frontUuid": "c5a85a6f-67d8-4520-8aef-666156ac3125",
    "sessionUuid": "d5149c86-0bcf-4c5d-a7f7-626e2c6a1737",
    "stamp": "LL5...lDw=="
  }
}
```

If `meta.encrypted` is `true` then all message data is signed and encrypted:

```json
{
  "data": "N9n...8j8=",
  "meta": {
    "encrypted": true
  }
}
```

### Call Response Meta


Metadata for responses on call-messages - `TeqFw_Web_Event_Shared_Dto_Event_Meta_Trans_Response`:

```json
{
  "meta": {
    "requestUuid": "c145c341-bdae-4f49-803f-91927394f650"
  }
}
```